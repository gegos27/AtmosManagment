<!doctype html>
<html lang="he" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATMOS - × ×™×”×•×œ × ×¨×’×™×œ×•×ª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Assistant', sans-serif; background-color: #0f172a; color: white; }
    .table-card { transition: all 0.3s ease; }
    .tab-active { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; }
    .modal-backdrop { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); }
    .timer-warning { animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
  </style>
 </head>
 <body class="h-full overflow-hidden">
  <div id="app" class="h-full flex flex-col">
   <header class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between">
     <h1 class="text-2xl font-black text-indigo-500 uppercase">ATMOS LOUNGE</h1>
     <div class="flex items-center gap-4">
        <div id="current-time" class="text-xs text-gray-500 font-mono"></div>
        <div class="bg-gray-800 px-3 py-1 rounded-lg text-sm border border-gray-700">
            ×¢×•×‘×“: <span id="current-staff-name" class="font-bold">×× ×”×œ</span>
        </div>
     </div>
   </header>

   <nav class="bg-gray-900 px-4 py-2 flex gap-2 border-b border-gray-800 overflow-x-auto scrollbar-thin">
     <button onclick="switchTab('tables')" id="tab-tables" class="tab-btn tab-active px-4 py-2 rounded-lg text-sm font-bold">ğŸª‘ ×©×•×œ×—× ×•×ª</button>
     <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn bg-gray-800 px-4 py-2 rounded-lg text-sm font-bold text-gray-400">ğŸ“¦ ××œ××™</button>
     <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-btn bg-gray-800 px-4 py-2 rounded-lg text-sm font-bold text-gray-400">ğŸ“ˆ ×× ×œ×™×˜×™×§×¡</button>
     <button onclick="switchTab('archive')" id="tab-archive" class="tab-btn bg-gray-800 px-4 py-2 rounded-lg text-sm font-bold text-gray-400">ğŸ—‚ï¸ ××¨×›×™×•×Ÿ</button>
   </nav>

   <main class="flex-1 p-6 overflow-y-auto scrollbar-thin">
    <div id="view-tables" class="view-content flex flex-col h-full">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold">××¦×‘ ×©×•×œ×—× ×•×ª</h2>
      <button onclick="openAddTableModal()" class="bg-indigo-600 px-6 py-2 rounded-xl font-bold shadow-lg shadow-indigo-500/20">×¤×ª×— ×©×•×œ×—×Ÿ</button>
     </div>
     <div id="tables-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-10"></div>
     <div class="mt-auto pb-6 flex justify-center">
        <button onclick="closeShift()" class="bg-red-600 hover:bg-red-500 px-10 py-4 rounded-2xl font-black text-xl shadow-2xl">ğŸ ×¡×’×™×¨×ª ××©××¨×ª</button>
     </div>
    </div>

    <div id="view-inventory" class="view-content hidden"><div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></div>
    <div id="view-analytics" class="view-content hidden"><div id="analytics-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div>
    <div id="view-archive" class="view-content hidden"><div id="archive-list" class="space-y-4 max-w-2xl mx-auto"></div></div>
   </main>
  </div>

  <div id="modal-container" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
   <div id="modal-content" class="bg-gray-900 rounded-3xl max-w-lg w-full max-h-[90%] overflow-y-auto border border-gray-800 p-6 shadow-2xl scrollbar-thin"></div>
  </div>

  <script>
    const STAGES = [{n:'×–××Ÿ ×”×›× ×”', d:15*60}, {n:'×’×—×œ×™× 1', d:30*60}, {n:'×’×—×œ×™× 2', d:30*60}];
    const menuItems = [
      { id: 'f1', name: 'Pinkman', price: 85, cat: '××•×¢×“×¤×™×' },
      { id: 'f2', name: 'Lemon Mint', price: 80, cat: '××•×¢×“×¤×™×' },
      { id: 'f3', name: 'Ice Blueberry Mint', price: 80, cat: '××•×¢×“×¤×™×' },
      { id: 'm1', name: 'Purple Skitlzz', price: 80, cat: 'Mono' },
      { id: 'ds1', name: 'Cosmo Flower', price: 90, cat: 'Darkside' },
      { id: 'mh1', name: 'Nord Star', price: 90, cat: 'Musthave' },
      { id: 'mx1', name: 'chill%thrill', price: 95, cat: 'Mixes' }
    ];

    let tables = [];
    let daily = { rev:0, orders:0, cash:0, credit:0, flavors:{}, table_rev:{}, log:[] };
    let archive = JSON.parse(localStorage.getItem('atmos_archive')) || [];

    async function initApp() {
      if (window.dataSdk) {
        await window.dataSdk.init((data) => {
          tables = data.filter(d => d.type === 'table');
          const dData = data.filter(d => d.type === 'daily');
          if (dData.length > 0) daily = dData[0];
          render();
        });
      }
      setInterval(() => { updateClock(); tick(); }, 1000);
    }

    function render() {
      const grid = document.getElementById('tables-grid');
      grid.innerHTML = '';
      tables.forEach(t => {
        const color = t.is_paid ? '#1e293b' : `hsl(${t.color_hue || 220}, 60%, 45%)`;
        const card = document.createElement('div');
        card.className = `table-card p-6 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer relative shadow-lg ${t.is_paid ? 'opacity-50' : ''}`;
        card.style.backgroundColor = color;
        card.onclick = () => openTableModal(t);
        card.innerHTML = `
            <div class="text-2xl font-black mb-1">${t.table_name}</div>
            <div class="text-[10px] font-bold bg-black/20 px-3 py-1 rounded-full">${getTimerText(t)}</div>
            <button onclick="event.stopPropagation(); deleteTable('${t.table_id}')" class="absolute top-2 left-2 text-white/20 hover:text-white">âœ•</button>
        `;
        grid.appendChild(card);
      });
      renderStats();
    }

    function getTimerText(t) {
      if (!t.timer_start_time || t.is_paid) return '×¤× ×•×™';
      const s = t.timer_stage || 0;
      if (s >= STAGES.length) return '××•×›×Ÿ';
      const rem = Math.max(0, STAGES[s].d - Math.floor((Date.now() - t.timer_start_time) / 1000));
      return `${STAGES[s].n}: ${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
    }

    function tick() {
      tables.forEach(t => {
        if (t.timer_start_time && !t.is_paid) {
          const s = t.timer_stage || 0;
          if (Math.floor((Date.now() - t.timer_start_time) / 1000) >= STAGES[s].d && s < STAGES.length) {
            t.timer_stage = s + 1; t.timer_start_time = Date.now();
            window.dataSdk.update(t);
          }
        }
      });
      render();
    }

    function openTableModal(t) {
      const modal = document.getElementById('modal-content');
      const total = (t.order_items || []).reduce((a,b) => a + (b.price * b.quantity), 0);
      modal.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">${t.table_name}</h2>
            <button onclick="closeModal()" class="text-gray-500 text-xl">âœ•</button>
        </div>
        ${t.timer_start_time && !t.is_paid ? `
            <div class="bg-gray-800 p-4 rounded-2xl mb-6 flex justify-between items-center border border-gray-700">
                <div class="font-bold text-indigo-400">${getTimerText(t)}</div>
                <div class="flex gap-2">
                    <button onclick="skipTimer('${t.table_id}')" class="bg-indigo-600/20 text-indigo-400 px-3 py-1 rounded-lg text-xs font-bold">×“×œ×’ â”</button>
                    <button onclick="openPaymentModal('${t.table_id}')" class="bg-green-600/20 text-green-400 px-3 py-1 rounded-lg text-xs font-bold">×œ×ª×©×œ×•× ğŸ’°</button>
                </div>
            </div>` : ''}
        <div class="mb-6">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">×”×–×× ×” (â‚ª${total})</h3>
            <div class="max-h-32 overflow-y-auto space-y-2 pr-2 scrollbar-thin">
                ${(t.order_items || []).map(i => `<div class="flex justify-between bg-gray-800 p-2 rounded-lg text-sm"><span>${i.name} x${i.quantity}</span><button onclick="removeItem('${t.table_id}','${i.id}')" class="text-red-500">××—×§</button></div>`).join('')}
            </div>
        </div>
        <div class="grid grid-cols-2 gap-2 h-40 overflow-y-auto border-t border-gray-800 pt-4 scrollbar-thin">
            ${menuItems.map(m => `<button onclick="addItem('${t.table_id}','${m.id}')" class="bg-gray-800 p-2 rounded-xl text-right text-[10px] font-bold border border-gray-700">${m.name}<br>â‚ª${m.price}</button>`).join('')}
        </div>
        <div class="mt-6">
            ${!t.timer_start_time && !t.is_paid ? `<button onclick="startOrder('${t.table_id}')" class="w-full bg-indigo-600 py-4 rounded-xl font-black">×”×›× ×¡×ª ×”×–×× ×”</button>` : 
            t.is_paid ? `<button onclick="deleteTable('${t.table_id}')" class="w-full bg-red-600/20 text-red-500 py-4 rounded-xl">××—×§ ×©×•×œ×—×Ÿ</button>` :
            `<button onclick="openPaymentModal('${t.table_id}')" class="w-full bg-green-600 py-4 rounded-xl font-black">×œ×ª×©×œ×•×</button>`}
        </div>
      `;
      openModal();
    }

    function openPaymentModal(id) {
        const t = tables.find(x => x.table_id === id);
        const total = (t.order_items || []).reduce((a,b) => a + (b.price * b.quantity), 0);
        const modal = document.getElementById('modal-content');
        modal.innerHTML = `
            <div class="text-center p-4">
                <h2 class="text-4xl font-black mb-8 text-indigo-400">â‚ª${total}</h2>
                <div class="mb-6 text-right">
                    <label class="text-xs text-gray-500 mr-1">×¡×›×•× ×©×©×•×œ×:</label>
                    <input type="number" id="pay-amt" value="${total}" class="w-full bg-gray-800 p-4 rounded-xl text-center text-2xl font-black outline-none border border-gray-700">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button onclick="window.payM='cash'; processPayment('${id}')" class="bg-gray-800 p-6 rounded-3xl font-bold border border-gray-700">ğŸ’µ ××–×•××Ÿ</button>
                    <button onclick="window.payM='credit'; processPayment('${id}')" class="bg-gray-800 p-6 rounded-3xl font-bold border border-gray-700">ğŸ’³ ××©×¨××™</button>
                </div>
                <button onclick="closeModal()" class="text-gray-500">×‘×™×˜×•×œ</button>
            </div>
        `;
    }

    async function processPayment(id) {
        const t = tables.find(x => x.table_id === id);
        const method = window.payM;
        const total = (t.order_items || []).reduce((a,b) => a + (b.price * b.quantity), 0);
        t.is_paid = true; t.timer_start_time = null;
        daily.rev += total; daily.orders++;
        if(method==='cash') daily.cash+=total; else daily.credit+=total;
        daily.log.push({ t:t.table_name, m:method, a:total });
        (t.order_items || []).forEach(i => daily.flavors[i.name] = (daily.flavors[i.name] || 0) + i.quantity);
        await window.dataSdk.update(t); await window.dataSdk.update(daily);
        closeModal();
    }

    async function closeShift() {
        if(!confirm("×¡×’×•×¨ ××©××¨×ª? ×”×›×œ ×™×¢×‘×•×¨ ×œ××¨×›×™×•×Ÿ.")) return;
        archive.push({ date: new Date().toLocaleString('he-IL'), daily: {...daily}, tables: tables.filter(t=>t.is_paid) });
        localStorage.setItem('atmos_archive', JSON.stringify(archive));
        for(let t of tables) await window.dataSdk.delete(t);
        daily = { rev:0, orders:0, cash:0, credit:0, flavors:{}, table_rev:{}, log:[] };
        await window.dataSdk.update(daily); location.reload();
    }

    function renderStats() {
        const div = document.getElementById('analytics-grid');
        div.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-3xl border border-gray-700">
                <h3 class="text-indigo-400 font-bold mb-4 underline">×˜×¢××™× ××•×‘×™×œ×™×</h3>
                ${Object.entries(daily.flavors || {}).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n,q])=>`<div class="flex justify-between text-sm py-1"><span>${n}</span><b>${q}</b></div>`).join('')}
            </div>
            <div class="bg-gray-800 p-6 rounded-3xl border border-gray-700">
                <h3 class="text-indigo-400 font-bold mb-4 underline">×ª×©×œ×•××™×</h3>
                <div class="text-xs mb-3">××–×•××Ÿ: â‚ª${daily.cash} | ××©×¨××™: â‚ª${daily.credit}</div>
                <div class="max-h-24 overflow-y-auto space-y-1 text-[10px] text-gray-500 scrollbar-thin">
                    ${(daily.log || []).map(l => `<div>${l.t}: â‚ª${l.a} (${l.m==='cash'?'××–×•××Ÿ':'××©×¨××™'})</div>`).join('')}
                </div>
            </div>
        `;
    }

    function renderArchive() {
        const list = document.getElementById('archive-list');
        list.innerHTML = archive.slice().reverse().map(s => `
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 flex justify-between items-center">
                <div><div class="text-[10px] text-gray-500">${s.date}</div><div class="font-bold">â‚ª${s.daily.rev}</div></div>
                <div class="text-[10px] text-gray-400">${s.tables.map(t=>t.table_name).join(', ')}</div>
            </div>
        `).join('');
    }

    // --- Actions ---
    async function startOrder(id) {
        const t = tables.find(x => x.table_id === id);
        t.timer_start_time = Date.now(); t.timer_stage = 0;
        await window.dataSdk.update(t); closeModal();
    }
    async function skipTimer(id) {
        const t = tables.find(x => x.table_id === id);
        t.timer_stage++; t.timer_start_time = Date.now();
        await window.dataSdk.update(t); openTableModal(t);
    }
    async function addItem(tid, mid) {
        const t = tables.find(x => x.table_id === tid), m = menuItems.find(x => x.id === mid);
        if(!t.order_items) t.order_items = [];
        const ex = t.order_items.find(x => x.id === mid);
        if(ex) ex.quantity++; else t.order_items.push({...m, quantity:1});
        await window.dataSdk.update(t); openTableModal(t);
    }
    async function removeItem(tid, mid) {
        const t = tables.find(x => x.table_id === tid);
        t.order_items = t.order_items.filter(i => i.id !== mid);
        await window.dataSdk.update(t); openTableModal(t);
    }
    async function deleteTable(id) { if(confirm("××—×™×§×ª ×©×•×œ×—×Ÿ?")) { const t = tables.find(x=>x.table_id===id); await window.dataSdk.delete(t); } }
    async function handleAddTable() {
        const n = document.getElementById('new-name').value;
        if(!n) return;
        await window.dataSdk.create({ type:'table', table_id:'t'+Date.now(), table_name:n, color_hue:Math.floor(Math.random()*360), order_items:[], is_paid:false, timer_stage:0, timer_start_time:null });
        closeModal();
    }
    function switchTab(id) {
        document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-'+id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active', 'text-white'));
        document.getElementById('tab-'+id).classList.add('tab-active');
    }
    function updateClock() { document.getElementById('current-time').textContent = new Date().toLocaleTimeString('he-IL'); }
    function openModal() { document.getElementById('modal-container').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
    function changeUser() { const u = prompt("×©× ×¢×•×‘×“:"); if(u) document.getElementById('current-staff-name').textContent = u; }
    function openAddTableModal() {
        const modal = document.getElementById('modal-content');
        modal.innerHTML = `<div class="text-center p-4"><h2 class="text-xl font-black mb-6">×¤×ª×— ×©×•×œ×—×Ÿ</h2><input type="text" id="new-name" placeholder="×©×/××¡×¤×¨" class="w-full bg-gray-800 p-4 rounded-xl text-center text-xl font-bold border border-gray-700 mb-6 outline-none"><button onclick="handleAddTable()" class="w-full bg-indigo-600 py-4 rounded-xl font-bold">××™×©×•×¨</button></div>`;
        openModal();
    }
    initApp();
  </script>
 </body>
</html>
