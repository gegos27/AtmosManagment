<!doctype html>
<html lang="he" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATMOS - × ×™×”×•×œ × ×¨×’×™×œ×•×ª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Assistant', sans-serif; background-color: #0f172a; }
    .table-card { transition: all 0.3s ease; }
    .status-closed { opacity: 0.6; filter: saturate(0.5); }
    .timer-warning { animation: pulse 1s ease-in-out infinite; color: white; font-weight: 800; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .tab-active { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; }
    .modal-backdrop { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
  </style>
 </head>
 <body class="h-full text-gray-100 overflow-hidden">
  <div id="app" class="h-full flex flex-col">
   <header class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
     <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 11c0 3.517-2.103 6.542-5.11 7.783L5.5 21h13l-1.39-2.217C14.103 17.542 12 14.517 12 11zM12 11V3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
     </div>
     <h1 class="text-2xl font-black tracking-tight text-white uppercase">ATMOS LOUNGE</h1>
    </div>
    <div class="flex items-center gap-6">
     <div id="current-time" class="text-gray-400 font-mono text-sm hidden md:block"></div>
     <div id="staff-display" class="bg-gray-800 px-3 py-1 rounded-lg border border-gray-700 text-sm">
        ×¢×•×‘×“: <span id="current-staff-name" class="font-bold">×× ×”×œ</span>
     </div>
    </div>
   </header>

   <nav class="bg-gray-900 px-6 py-2 flex gap-2 border-b border-gray-800 overflow-x-auto">
     <button onclick="switchTab('tables')" id="tab-tables" class="tab-btn tab-active px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">ğŸª‘ ×©×•×œ×—× ×•×ª</button>
     <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn bg-gray-800 px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">ğŸ“¦ ××œ××™</button>
     <button onclick="switchTab('daily')" id="tab-daily" class="tab-btn bg-gray-800 px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">ğŸ“Š ×¡×™×›×•× ×™×•×</button>
     <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-btn bg-gray-800 px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">ğŸ“ˆ ×× ×œ×™×˜×™×§×¡</button>
     <button onclick="switchTab('archive')" id="tab-archive" class="tab-btn bg-gray-800 px-5 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">ğŸ—‚ï¸ ××¨×›×™×•×Ÿ</button>
   </nav>

   <main class="flex-1 p-6 overflow-y-auto scrollbar-thin">
    <div id="view-tables" class="view-content h-full flex flex-col">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold">××¦×‘ ×©×•×œ×—× ×•×ª</h2>
      <button onclick="openAddTableModal()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg">
       + ×¤×ª×— ×©×•×œ×—×Ÿ
      </button>
     </div>
     <div id="tables-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-8"></div>
     
     <div class="mt-auto pt-6 border-t border-gray-800 flex justify-center">
        <button onclick="closeShift()" class="bg-red-600 hover:bg-red-500 px-12 py-4 rounded-2xl font-black text-xl shadow-2xl transition-transform active:scale-95">
            ğŸ ×¡×’×™×¨×ª ××©××¨×ª
        </button>
     </div>
    </div>

    <div id="view-inventory" class="view-content hidden">
      <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <div id="view-daily" class="view-content hidden text-center">
        <div id="daily-summary-box" class="max-w-md mx-auto bg-gray-800 p-8 rounded-3xl border border-gray-700"></div>
    </div>

    <div id="view-analytics" class="view-content hidden">
        <div id="analytics-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <div id="view-archive" class="view-content hidden">
        <h2 class="text-2xl font-bold mb-6 text-purple-400">××¨×›×™×•×Ÿ ××©××¨×•×ª ğŸ—‚ï¸</h2>
        <div id="archive-list" class="space-y-6"></div>
    </div>
   </main>
  </div>

  <div id="modal-container" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
   <div id="modal-content" class="bg-gray-900 rounded-3xl max-w-lg w-full max-h-[90%] overflow-y-auto border border-gray-700 shadow-2xl"></div>
  </div>

  <div id="toast-container" class="fixed bottom-6 left-6 z-50 space-y-3"></div>

  <script>
    const STAGES = [{n:'×–××Ÿ ×”×›× ×”', d:15*60}, {n:'×”×—×œ×¤×ª ×’×—×œ×™×', d:30*60}, {n:'×”×—×œ×¤×ª ×’×—×œ×™×', d:30*60}];
    
    // × ×ª×•× ×™ ×ª×¤×¨×™×˜
    const menuItems = [
      { id: 'fav1', name: 'Pinkman', price: 85, category: '××•×¢×“×¤×™×' },
      { id: 'fav2', name: 'Lemon Mint', price: 80, category: '××•×¢×“×¤×™×' },
      { id: 'fav3', name: 'Ice Blueberry Mint', price: 80, category: '××•×¢×“×¤×™×' },
      { id: 'm1', name: 'Purple Skitlzz', price: 80, category: 'mono' },
      { id: 'ds1', name: 'Cosmo Flower', price: 90, category: 'dark side' },
      { id: 'mh1', name: 'Nord Star', price: 90, category: 'musthave' },
      { id: 'mx1', name: 'chill%thrill', price: 95, category: '××™×§×¡×™×' }
    ];

    let tables = JSON.parse(localStorage.getItem('atmos_tables')) || [];
    let daily = JSON.parse(localStorage.getItem('atmos_daily')) || { rev:0, orders:0, cash:0, credit:0, flavors:{}, table_rev:{}, payments:[], hour_log:{} };
    let archive = JSON.parse(localStorage.getItem('atmos_archive')) || [];

    function init() {
        render();
        setInterval(() => {
            updateClock();
            tickTimers();
        }, 1000);
    }

    function render() {
        const grid = document.getElementById('tables-grid');
        grid.innerHTML = '';
        
        tables.forEach(t => {
            const hue = t.hue || 220;
            const isClosed = t.paid;
            const bgColor = isClosed ? '#334155' : `hsl(${hue}, 60%, 45%)`;
            
            const card = document.createElement('div');
            card.className = `table-card p-6 rounded-2xl shadow-xl flex flex-col items-center justify-center text-center cursor-pointer relative ${isClosed ? 'status-closed' : ''}`;
            card.style.backgroundColor = bgColor;
            card.onclick = () => openTableModal(t.id);
            
            card.innerHTML = `
                <div class="absolute top-2 right-3 text-[10px] font-black opacity-50">#${t.id.slice(-3)}</div>
                <div class="text-2xl font-black mb-2">${t.name}</div>
                <div class="text-sm font-bold bg-black/20 px-3 py-1 rounded-full">${getTimerText(t)}</div>
                <button onclick="event.stopPropagation(); deleteTable('${t.id}')" class="absolute top-2 left-2 text-white/30 hover:text-white">âœ•</button>
            `;
            grid.appendChild(card);
        });

        // ×¢×“×›×•×Ÿ ×¡×™×›×•× ×™×•×
        const summary = document.getElementById('daily-summary-box');
        summary.innerHTML = `
            <h2 class="text-2xl font-black mb-6 uppercase">×¡×™×›×•× ××©××¨×ª × ×•×›×—×™×ª</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-900 p-4 rounded-2xl"><div class="text-xs text-gray-500">×”×›× ×¡×•×ª</div><div class="text-2xl font-bold text-green-400">â‚ª${daily.rev}</div></div>
                <div class="bg-gray-900 p-4 rounded-2xl"><div class="text-xs text-gray-500">×”×–×× ×•×ª</div><div class="text-2xl font-bold text-indigo-400">${daily.orders}</div></div>
            </div>
            <div class="mt-4 p-4 bg-gray-900 rounded-2xl text-sm">
                ××–×•××Ÿ: â‚ª${daily.cash} | ××©×¨××™: â‚ª${daily.credit}
            </div>
        `;

        renderAnalytics();
        renderArchive();
    }

    function getTimerText(t) {
        if (!t.start || t.paid) return '×¤× ×•×™';
        const s = t.stage || 0;
        if (s >= STAGES.length) return 'âœ“ ××•×›×Ÿ';
        const rem = Math.max(0, STAGES[s].d - Math.floor((Date.now() - t.start) / 1000));
        const m = Math.floor(rem/60), s_ = rem%60;
        return `<span class="${rem < 60 ? 'timer-warning' : ''}">${STAGES[s].n}: ${m}:${s_ < 10 ? '0'+s_ : s_}</span>`;
    }

    function tickTimers() {
        let changed = false;
        tables.forEach(t => {
            if (t.start && !t.paid) {
                const s = t.stage || 0;
                if (s < STAGES.length && (Date.now() - t.start)/1000 >= STAGES[s].d) {
                    t.stage = s + 1;
                    t.start = Date.now();
                    changed = true;
                }
            }
        });
        if (changed) { save(); render(); }
        else { 
            // ×¨×§ ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×˜×™×™××¨×™× ×‘×œ×™ ×¨× ×“×•×¨ ××œ× ×©×œ ×›×œ ×”-DOM
            document.querySelectorAll('.table-card').forEach((card, idx) => {
                const t = tables[idx];
                if (t) card.querySelector('.text-sm').innerHTML = getTimerText(t);
            });
        }
    }

    function openTableModal(id) {
        const t = tables.find(x => x.id === id);
        const total = t.items.reduce((a,b) => a + (b.price * b.qty), 0);
        const modal = document.getElementById('modal-content');
        
        modal.innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">${t.name}</h2>
                    <button onclick="closeModal()" class="text-gray-500">âœ•</button>
                </div>
                
                ${t.start && !t.paid ? `
                <div class="bg-gray-800 p-4 rounded-2xl mb-6 flex justify-between items-center border border-gray-700">
                    <div class="font-bold">${getTimerText(t)}</div>
                    <div class="flex gap-2">
                        <button onclick="skipTimer('${id}')" class="bg-indigo-600/20 text-indigo-400 px-4 py-2 rounded-xl text-xs font-bold">×“×œ×’ â”</button>
                        <button onclick="openPaymentModal('${id}')" class="bg-green-600/20 text-green-400 px-4 py-2 rounded-xl text-xs font-bold">×“×™×œ×•×’ ×œ×ª×©×œ×•× ğŸ’°</button>
                    </div>
                </div>` : ''}

                <div class="mb-6">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">×”×–×× ×” (â‚ª${total})</h3>
                    <div class="space-y-2 max-h-40 overflow-y-auto pr-2 scrollbar-thin">
                        ${t.items.map(i => `
                            <div class="flex justify-between bg-gray-800 p-3 rounded-xl border border-gray-700">
                                <span>${i.name} x${i.qty}</span>
                                <button onclick="removeItem('${t.id}','${i.id}')" class="text-red-500 font-bold">××—×§</button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 h-48 overflow-y-auto border-t border-gray-800 pt-4 scrollbar-thin">
                    ${menuItems.map(m => `<button onclick="addItem('${t.id}','${m.id}')" class="bg-gray-800 p-3 rounded-xl text-right text-xs border border-gray-700 font-bold">${m.name}<br><span class="text-gray-500">â‚ª${m.price}</span></button>`).join('')}
                </div>

                <div class="pt-6">
                    ${!t.start && !t.paid ? `
                        <button onclick="startOrder('${t.id}')" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-lg">×”×›× ×¡×ª ×”×–×× ×”</button>
                    ` : t.paid ? `
                        <button onclick="deleteTable('${t.id}')" class="w-full bg-red-600/20 text-red-500 py-4 rounded-2xl font-bold">××—×§ ×©×•×œ×—×Ÿ</button>
                    ` : `
                        <button onclick="openPaymentModal('${t.id}')" class="w-full bg-green-600 py-4 rounded-2xl font-black text-lg">×œ×ª×©×œ×•×</button>
                    `}
                </div>
            </div>
        `;
        showModal();
    }

    function startOrder(id) {
        const t = tables.find(x => x.id === id);
        t.start = Date.now(); t.stage = 0;
        const hour = new Date().getHours();
        daily.hour_log[hour] = (daily.hour_log[hour] || 0) + 1;
        save(); closeModal(); render();
    }

    function skipTimer(id) {
        const t = tables.find(x => x.id === id);
        t.stage++; t.start = Date.now();
        save(); openTableModal(id);
    }

    function openPaymentModal(id) {
        const t = tables.find(x => x.id === id);
        const total = t.items.reduce((a,b) => a + (b.price * b.qty), 0);
        const modal = document.getElementById('modal-content');
        modal.innerHTML = `
            <div class="p-8 text-center">
                <h2 class="text-4xl font-black mb-8 text-indigo-400">â‚ª${total}</h2>
                <div class="mb-6">
                    <label class="block text-right text-xs text-gray-400 mb-2">×¡×›×•× ×©×©×•×œ×:</label>
                    <input type="number" id="pay-input" value="${total}" class="w-full bg-gray-800 p-4 rounded-2xl text-center text-2xl font-black border border-gray-700 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="setMethod('cash')" id="m-cash" class="bg-gray-800 p-6 rounded-3xl border-2 border-transparent font-bold">ğŸ’µ ××–×•××Ÿ</button>
                    <button onclick="setMethod('credit')" id="m-credit" class="bg-gray-800 p-6 rounded-3xl border-2 border-transparent font-bold">ğŸ’³ ××©×¨××™</button>
                </div>
                <button onclick="finishPayment('${id}')" class="w-full bg-indigo-600 py-5 rounded-2xl font-black text-xl shadow-lg">×¡×™×•×</button>
            </div>
        `;
        window.tempMethod = 'cash'; setMethod('cash');
    }

    function setMethod(m) {
        window.tempMethod = m;
        document.getElementById('m-cash').style.borderColor = m === 'cash' ? '#6366f1' : 'transparent';
        document.getElementById('m-credit').style.borderColor = m === 'credit' ? '#6366f1' : 'transparent';
    }

    function finishPayment(id) {
        const t = tables.find(x => x.id === id);
        const amt = t.items.reduce((a,b) => a + (b.price * b.qty), 0);
        const method = window.tempMethod;
        
        t.paid = true;
        t.start = null;
        daily.rev += amt;
        daily.orders++;
        if(method === 'cash') daily.cash += amt; else daily.credit += amt;
        
        // ×œ×•×’ ×œ×× ×œ×™×˜×™×§×¡
        daily.payments.push({ table: t.name, method: method, amount: amt });
        t.items.forEach(i => daily.flavors[i.name] = (daily.flavors[i.name] || 0) + i.qty);
        daily.table_rev[t.name] = (daily.table_rev[t.name] || 0) + amt;

        save(); closeModal(); render();
    }

    function closeShift() {
        if (!confirm("×”×× ×œ×¡×’×•×¨ ××©××¨×ª ×•×œ×”×¢×‘×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ××¨×›×™×•×Ÿ?")) return;
        
        const shiftData = {
            date: new Date().toLocaleString('he-IL'),
            daily: { ...daily },
            tables: tables.filter(t => t.paid).map(t => ({...t}))
        };
        
        archive.push(shiftData);
        localStorage.setItem('atmos_archive', JSON.stringify(archive));
        
        // ××™×¤×•×¡ ××©××¨×ª
        tables = [];
        daily = { rev:0, orders:0, cash:0, credit:0, flavors:{}, table_rev:{}, payments:[], hour_log:{} };
        save();
        render();
        switchTab('archive');
        alert("×”××©××¨×ª × ×¡×’×¨×” ×•× ×•×¡×¤×” ×œ××¨×›×™×•×Ÿ!");
    }

    function renderAnalytics() {
        const div = document.getElementById('analytics-content');
        div.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-3xl border border-gray-700">
                <h3 class="font-bold text-indigo-400 mb-4 underline">×˜×¢××™× ××•×‘×™×œ×™×</h3>
                ${Object.entries(daily.flavors).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n,q])=>`<div class="flex justify-between text-sm py-1"><span>${n}</span><b>${q}</b></div>`).join('')}
            </div>
            <div class="bg-gray-800 p-6 rounded-3xl border border-gray-700">
                <h3 class="font-bold text-indigo-400 mb-4 underline">×”×ª×¤×œ×’×•×ª ×ª×©×œ×•××™×</h3>
                <div class="text-sm mb-4"><b>××–×•××Ÿ:</b> â‚ª${daily.cash} | <b>××©×¨××™:</b> â‚ª${daily.credit}</div>
                <div class="max-h-32 overflow-y-auto text-[10px] text-gray-500">
                    ${daily.payments.map(p => `<div>${p.table}: â‚ª${p.amount} (${p.method === 'cash' ? '××–×•××Ÿ' : '××©×¨××™'})</div>`).join('')}
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-3xl border border-gray-700">
                <h3 class="font-bold text-indigo-400 mb-4 underline">×”×›× ×¡×•×ª ×œ×¤×™ ×©×•×œ×—×Ÿ</h3>
                ${Object.entries(daily.table_rev).sort((a,b)=>b[1]-a[1]).map(([n,r])=>`<div class="flex justify-between text-sm"><span>${n}</span><b>â‚ª${r}</b></div>`).join('')}
            </div>
        `;
    }

    function renderArchive() {
        const list = document.getElementById('archive-list');
        list.innerHTML = archive.slice().reverse().map((s, idx) => `
            <div class="bg-gray-800 rounded-3xl border border-gray-700 overflow-hidden">
                <div class="bg-gray-900 px-6 py-4 font-bold border-b border-gray-700 flex justify-between">
                    <span>${s.date}</span>
                    <span class="text-green-400">â‚ª${s.daily.rev}</span>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                    <div>
                        <b class="text-indigo-400 block mb-2">× ×ª×•× ×™×:</b>
                        ×”×–×× ×•×ª: ${s.daily.orders}<br>
                        ××–×•××Ÿ: â‚ª${s.daily.cash} / ××©×¨××™: â‚ª${s.daily.credit}
                    </div>
                    <div>
                        <b class="text-indigo-400 block mb-2">×˜×¢××™× ××•×‘×™×œ×™×:</b>
                        ${Object.entries(s.daily.flavors).sort((a,b)=>b[1]-a[1]).slice(0,3).map(f => `${f[0]} (${f[1]})`).join(', ')}
                    </div>
                    <div class="max-h-24 overflow-y-auto">
                        <b class="text-indigo-400 block mb-2">×©×•×œ×—× ×•×ª ×•×”×–×× ×•×ª:</b>
                        ${s.tables.map(t => `${t.name}: ${JSON.parse(JSON.stringify(t.items)).map(i => i.name).join(', ')}`).join('<br>')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    // --- Helpers ---
    function save() {
        localStorage.setItem('atmos_tables', JSON.stringify(tables));
        localStorage.setItem('atmos_daily', JSON.stringify(daily));
    }
    function switchTab(id) {
        document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-'+id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active', 'bg-gray-800'));
        document.getElementById('tab-'+id).classList.add('tab-active');
        if(id === 'analytics') renderAnalytics();
        if(id === 'archive') renderArchive();
    }
    function openAddTableModal() {
        const modal = document.getElementById('modal-content');
        modal.innerHTML = `
            <div class="p-8">
                <h2 class="text-2xl font-black mb-6">×¤×ª×— ×©×•×œ×—×Ÿ</h2>
                <input type="text" id="new-name" placeholder="×©×/××¡×¤×¨ ×©×•×œ×—×Ÿ" class="w-full bg-gray-800 border border-gray-700 rounded-2xl p-4 text-white text-center text-xl font-bold mb-6 outline-none">
                <button onclick="addTable()" class="w-full bg-indigo-600 py-4 rounded-2xl font-bold">××™×©×•×¨</button>
            </div>
        `;
        showModal();
    }
    function addTable() {
        const name = document.getElementById('new-name').value;
        if (!name) return;
        tables.push({ id: 't'+Date.now(), name, hue: Math.floor(Math.random()*360), items: [], paid: false, stage: 0, start: null });
        save(); closeModal(); render();
    }
    function deleteTable(id) {
        if(confirm("××—×™×§×ª ×©×•×œ×—×Ÿ?")) { tables = tables.filter(x => x.id !== id); save(); render(); }
    }
    function addItem(tid, mid) {
        const t = tables.find(x => x.id === tid), m = menuItems.find(x => x.id === mid);
        const ex = t.items.find(x => x.id === mid);
        if (ex) ex.qty++; else t.items.push({...m, qty:1});
        save(); openTableModal(tid);
    }
    function removeItem(tid, mid) {
        const t = tables.find(x => x.id === tid);
        t.items = t.items.filter(x => x.id !== mid);
        save(); openTableModal(tid);
    }
    function updateClock() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleTimeString('he-IL');
    }
    function showModal() { document.getElementById('modal-container').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
    
    init();
  </script>
 </body>
</html>
